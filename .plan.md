## שלב 4: שיפור validation.utils.ts (type guard)

### קובץ: `shared/utils/validation.utils.ts`

**בעיה**: `detectedLanguage as keyof typeof COMMON_MISSPELLINGS`

**פתרון**: type guard

```typescript
// Before
const misspellings = COMMON_MISSPELLINGS[detectedLanguage as keyof typeof COMMON_MISSPELLINGS] as Record<string, string | string[]>;

// After
function isSupportedLanguage(lang: string): lang is keyof typeof COMMON_MISSPELLINGS {
    return lang in COMMON_MISSPELLINGS;
}

if (enableSpellCheck && isSupportedLanguage(detectedLanguage)) {
    const words = input.toLowerCase().split(/\s+/);
    const misspellings = COMMON_MISSPELLINGS[detectedLanguage];
    // ...
}
```

---

## שלב 5: שיפור globalException.filter.ts (type definition)

### קובץ: `server/src/common/globalException.filter.ts`

**בעיה**: `as Record<string, unknown>` - שינוי type של object קיים

**פתרון**: הגדר את errorResponse עם הטיפוס הנכון מראש

```typescript
// Before
(errorResponse as Record<string, unknown>).errorType = errorType;

// After
interface ErrorResponse {
    statusCode: number;
    message: string | string[];
    error?: string;
    errorType?: string;
    timestamp: string;
    path: string;
}

const errorResponse: ErrorResponse = {
    statusCode: status,
    message: message,
    timestamp: new Date().toISOString(),
    path: request.url,
};

if (status >= 400 && status < 500) {
    errorResponse.errorType = errorType;
}
```

---

## שלב 6: תיקון useAuth.ts (validation)

### קובץ: `client/src/hooks/useAuth.ts`

**בעיה**: `as UserRole` - cast של string ל-UserRole ללא validation

**פתרון**: הוסף type guard או validation

```typescript
// Before
role: typeof profile.role === 'string' ? (profile.role as UserRole) : UserRole.USER,

// After
function isValidUserRole(role: string): role is UserRole {
    return Object.values(UserRole).includes(role as UserRole);
}

role: typeof profile.role === 'string' && isValidUserRole(profile.role) 
    ? profile.role 
    : UserRole.USER,
```

---

## סדר ביצוע

1. תיקון user.controller.ts (קריטי - חסר validation)
2. שיפור leaderboard.service.ts (type-safe mapping)
3. שיפור analytics.service.ts (type guard)
4. שיפור validation.utils.ts (type guard)
5. שיפור globalException.filter.ts (type definition)
6. תיקון useAuth.ts (validation)
7. אימות compilation על server, client, shared
8. הרצת tests (אם קיימים)

### To-dos

- [ ] תיקון user.controller.ts - הוספת validation לפני type cast
- [ ] שיפור leaderboard.service.ts - type-safe mapping
- [ ] שיפור analytics.service.ts - type guard או Object.keys
- [ ] שיפור validation.utils.ts - type guard
- [ ] שיפור globalException.filter.ts - type definition
- [ ] תיקון useAuth.ts - validation
- [ ] אימות compilation על server, client, shared
